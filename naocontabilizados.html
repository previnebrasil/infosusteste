<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qualidade do Acompanhamento</title>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
body {
  margin: 0;
  padding: 0;
  background-color: #f4f6f9;
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  color: #333;
}

/* CONTAINER */
.container {
  max-width: 1400px;
  margin: 30px auto;
  padding: 30px;
  background: #ffffff;
  border-radius: 14px;
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
}

/* T√çTULO */
h1 {
  font-size: 30px;
  text-align: center;
  font-weight: 700;
  color: #003a70;
  margin-bottom: 25px;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

/* SELECTS */
.select-container {
  display: flex;
  gap: 25px;
  margin-bottom: 20px;
}

.select-container > div {
  flex: 1;
}

label {
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 4px;
  display: block;
  color: #444;
}

select {
  width: 100%;
  padding: 12px 16px;
  font-size: 15px;
  border: 2px solid #cfd6e2;
  border-radius: 8px;
  background: #fafafa;
  outline: none;
  transition: 0.25s;
}

select:hover {
  border-color: #9cb7d9;
}

select:focus {
  border-color: #003a70;
  background: #eef5ff;
}

/* BOT√ïES DE M√ìDULO */
.btn-container {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-bottom: 25px;
  flex-wrap: wrap;
}

.age-btn {
  padding: 10px 20px;
  background: linear-gradient(135deg, #007bff, #0056b3);
  color: white;
  font-size: 15px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: 0.25s;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
}

.age-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 7px 16px rgba(0, 0, 0, 0.2);
}

.age-btn.active {
  background: linear-gradient(135deg, #28a745, #1e7e34);
  box-shadow: 0 4px 14px rgba(0, 0, 0, 0.3);
}

.reset-btn {
  background: linear-gradient(135deg, #6c757d, #495057);
}

/* √çCONES COMO BOT√ïES */
#downloadContainer {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 4px;  /* ESPA√áAMENTO QUASE ZERO */
  margin-top: 5px;
  margin-bottom: 0 !important;
}

.btn-img {
  width: 150px;   /* ajuste fino do tamanho */
  cursor: pointer;
  user-select: none;
}

/* √ÅREA DA TABELA */
#csvContent {
  max-height: 650px;
  overflow: auto;
  margin-top: 25px;
  border-radius: 10px;
  border: 1px solid #d8dfeb;
}

/* TABELA */
table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  font-size: 15px;
}

table td,
table th {
  border-right: 1px solid #d4dbe6;
  border-bottom: 1px solid #d4dbe6;
}

table tr td:last-child,
table tr th:last-child {
  border-right: none;
}

/* CABE√áALHO */
th {
  background-color: #003a70;
  color: white;
  font-weight: 600;
  padding: 14px 10px;
  text-align: center;
  position: sticky;
  top: 0;
  z-index: 12;
}

/* primeira coluna fixa */
th:first-child {
  left: 0;
  position: sticky;
  z-index: 14;
}

td {
  padding: 12px 16px;
  background: #fbfbfb;
}

td:first-child {
  left: 0;
  position: sticky;
  z-index: 10;
  font-weight: 700;
  background: #e6f0fa;
  color: #003a70;
}

tr:nth-child(even) td {
  background: #f1f5fa;
}

/* HOVER sem interferir nas cores das pontua√ß√µes */
tr:hover td:not([style*="#e74c3c"]):not([style*="#3498db"]) {
  background-color: #e8f0ff !important;
}

/* ------------------------------
   TEMA ODONTO
------------------------------ */

body.modo-odonto {
  background-color: #F5FFF7 !important;
}

body.modo-odonto h1 {
  color: #2E8B57 !important;
}

body.modo-odonto th {
  background-color: #2E8B57 !important;
  color: white !important;
}

body.modo-odonto td:first-child {
  background-color: #E4F5E9 !important;
  color: #2E8B57 !important;
}

@media (max-width: 768px) {
  .select-container {
    flex-direction: column;
  }
}
  </style>
</head>
<body>
  <div class="container">
    <h1>Componente Qualidade - APS</h1>

    <!-- Bot√µes de m√≥dulo -->
    <div class="btn-container" style="margin-bottom: 30px;">
      <button class="age-btn active" id="btnAPS" onclick="switchModule('APS')">APS</button>
      <button class="age-btn" id="btnOdonto" onclick="switchModule('Odonto')">Odonto</button>
    </div>

    <div class="select-container">
      <div>
        <label for="indicadorSelect">Indicador:</label>
        <select id="indicadorSelect">
          <option value="Selecione">Selecione</option>
        </select>
      </div>
      <div>
        <label for="unidadeSelect">Unidade:</label>
        <select id="unidadeSelect">
          <option value="">Selecione</option>
          <!-- Unidades -->
          <option value="EAP CHICO MENDES">EAP CHICO MENDES</option>
                    <option value="EAP PLANALTO">EAP PLANALTO</option>
                    <option value="EAP SANTA ANTONIETA">EAP SANTA ANTONIETA</option>
                    <option value="EAP SAO JUDAS">EAP SAO JUDAS</option>
                    <option value="USF AEROPORTO">USF AEROPORTO</option>
                    <option value="USF ALTANEIRA">USF ALTANEIRA</option>
                    <option value="USF ANIZ BADRA">USF ANIZ BADRA</option>
                    <option value="USF ARGOLO FERRAO">USF ARGOLO FERRAO</option>
                    <option value="USF AVENCAS/ AMADEU AMARAL">USF AVENCAS AMADEU AMARAL</option>
                    <option value="USF BANDEIRANTES">USF BANDEIRANTES</option>
                    <option value="USF BANDEIRANTES II">USF BANDEIRANTES II</option>
                    <option value="USF CAMPO BELO">USF CAMPO BELO</option>
                    <option value="USF COSTA E SILVA">USF COSTA E SILVA</option>
                    <option value="USF COSTA E SILVA II">USF COSTA E SILVA II</option>
                    <option value="USF FIGUERINHA">USF FIGUERINHA</option>
                    <option value="USF JANIO QUADROS">USF JANIO QUADROS</option>
                    <option value="USF JARDIM AMERICA IV">USF JARDIM AMERICA IV</option>
                    <option value="USF JARDIM CAVALARI">USF JARDIM CAVALARI</option>
                    <option value="USF FLAMINGO">USF JARDIM FLAMINGO</option>
                    <option value="USF JARDIM MARACA">USF JARDIM MARACA</option>
                    <option value="USF JARDIM MARACA II">USF JARDIM MARACA II</option>
                    <option value="USF JARDIM MARILIA">USF JARDIM MARILIA</option>
                    <option value="USF JARDIM RENATA">USF JARDIM RENATA</option>
                    <option value="USF JARDIM TERUEL">USF JARDIM TERUEL</option>
                    <option value="USF JK">USF JK</option>
                    <option value="USF JK II">USF JK II</option>
                    <option value="USF JOQUEY CLUBE">USF JOQUEY CLUBE</option>
                    <option value="USF JULIETA">USF JULIETA</option>
                    <option value="USF LACIO">USF LACIO</option>
                    <option value="USF LEONEL DE MOURA BRIZOLA">USF LEONEL DE MOURA BRIZOLA</option>
                    <option value="USF LILIANA">USF LILIANA</option>
                    <option value="USF MARAJO">USF MARAJO</option>
                    <option value="USF NOVO HORIZONTE">USF NOVO HORIZONTE</option>
                    <option value="USF PADRE NOBREGA">USF PADRE NOBREGA</option>
                    <option value="USF PADRE NOBREGA II">USF PADRE NOBREGA II</option>
                    <option value="USF PALMITAL">USF PALMITAL</option>
                    <option value="USF PRIMAVERA/ NACOES/NOVA ALMEIDA">USF PARQUE DAS NACOES</option>
                    <option value="USF PARQUE DOS IPES">USF PARQUE DOS IPES</option>
                    <option value="USF PRIMEIRO DE MAIO">USF PRIMEIRO DE MAIO</option>
                    <option value="USF ROSALIA">USF ROSALIA</option>
                    <option value="USF SANTA ANTONIETA II">USF SANTA ANTONIETA II</option>
                    <option value="USF SANTA ANTONIETA III">USF SANTA ANTONIETA III</option>
                    <option value="USF SANTA AUGUSTA">USF SANTA AUGUSTA</option>
                    <option value="USF SANTA PAULA">USF SANTA PAULA</option>
                    <option value="USF SAO BENTO">USF SAO BENTO</option>
                    <option value="USF SAO MIGUEL">USF SAO MIGUEL</option>
                    <option value="USF SAO MIGUEL II">USF SAO MIGUEL II</option>
                    <option value="USF TOFOLI">USF TOFOLI</option>
                    <option value="USF TRES LAGOS">USF TRES LAGOS</option>
                    <option value="USF VIDA NOVA MARACA">USF VIDA NOVA MARACA</option>
                    <option value="USF VILA BARROS">USF VILA BARROS</option>
                    <option value="USF VILA HIPICA">USF VILA HIPICA</option>
                    <option value="USF VILA NOVA">USF VILA NOVA</option>
                    <option value="USF VILA REAL">USF VILA REAL</option>
        </select>
      </div>
    </div>

    <div id="faixaEtariaBtns" style="display:none;" class="btn-container">
      <button class="age-btn" onclick="filtrarFaixa(this,25,64)">Citopatol√≥gico (25 a 64)</button>
      <button class="age-btn" onclick="filtrarFaixa(this,9,14)">Vacina HPV (9 a 14)</button>
      <button class="age-btn" onclick="filtrarFaixa(this,14,69)">Aten√ß√£o Sexualidade (14 a 69)</button>
      <button class="age-btn" onclick="filtrarFaixa(this,50,69)">Mamografia (50 a 69)</button>
      <button class="reset-btn" onclick="removerFiltro()">Remover Filtro</button>
    </div>

    
    <div id="downloadContainer" class="download-vertical">
        <img src="excel.png" id="btnExcel" class="btn-img" style="display:none;">
        <img src="pdf.png" id="btnPdf" class="btn-img" style="display:none;">
    </div>
      
    <div id="csvContent"></div>
  </div>

  <script>
    const indicadoresAPS = [
      {value: 'c2', text: 'C2 - Cuidado no Desenvolvimento Infantil'},
      {value: 'c3', text: 'C3 - Cuidado da Gestante e Pu√©rpera'},
      {value: 'c4', text: 'C4 - Cuidado da Pessoa com Diabetes'},
      {value: 'c5', text: 'C5 - Cuidado da Pessoa com Hipertens√£o'},
      {value: 'c6', text: 'C6 - Cuidado da Pessoa Idosa'},
      {value: 'c7', text: 'C7 - Cuidado da Mulher na Preven√ß√£o do C√¢ncer'}
    ];

    const indicadoresOdonto = [
      {value: 'b2', text: 'B2 - Tratamento conclu√≠do'},
      {value: 'b3', text: 'B3 - Taxa de exodontia'},
      {value: 'b4', text: 'B4 - Escova√ß√£o supervisionada (6 a 12 anos)'},
      {value: 'b5', text: 'B5 - Procedimentos odontol√≥gicos preventivos'},
      {value: 'b6', text: 'B6 - Tratamento restaurador atraum√°tico'}
    ];

    let moduloAtual = 'APS';
    let ultimoCSV = "";
    let ultimaUnidade = "";
    let ultimaIdadeColIndex = -1;

    function switchModule(modulo) {
  moduloAtual = modulo;
  const btnAPS = document.getElementById('btnAPS');
  const btnOdonto = document.getElementById('btnOdonto');
  const titulo = document.querySelector('h1');
  const selectIndicador = document.getElementById('indicadorSelect');
  const selectUnidade = document.getElementById('unidadeSelect');

  // Alternar estilo dos bot√µes
  btnAPS.classList.toggle('active', modulo === 'APS');
  btnOdonto.classList.toggle('active', modulo === 'Odonto');

  // Resetar os selects
  selectIndicador.innerHTML = '<option value="Selecione">Selecione</option>';
  selectUnidade.value = "";   // <-- for√ßa limpar a unidade

  // Carregar indicadores corretos
  const lista = modulo === 'APS' ? indicadoresAPS : indicadoresOdonto;
  lista.forEach(i => {
    const opt = document.createElement('option');
    opt.value = i.value;
    opt.textContent = i.text;
    selectIndicador.appendChild(opt);
  });

  // Alterar t√≠tulo e tema
  if (modulo === 'APS') {
    titulo.textContent = "Componente Qualidade - APS";
    document.body.classList.remove('modo-odonto');
  } else {
    titulo.textContent = "Componente Qualidade - Odonto";
    document.body.classList.add('modo-odonto');
  }

  // ----------------------------
  // RESETAR ESTADO COMPLETAMENTE
  // ----------------------------

  // limpa √∫ltima unidade e csv armazenados
  ultimoCSV = "";
  ultimaUnidade = "";

  // esconder bot√µes de download
  document.getElementById('btnExcel').style.display = 'none';
  document.getElementById('btnPdf').style.display = 'none';

  // esconder bot√µes de faixa et√°ria
  document.getElementById('faixaEtariaBtns').style.display = 'none';

  // limpar tabela
  document.getElementById('csvContent').innerHTML = '';
}

    function formatDateBR(value) {
      const dateRegex = /^\d{4}-\d{2}-\d{2}/;
      if (dateRegex.test(value)) {
        const parts = value.substring(0, 10).split("-");
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
      }
      return value;
    }

    function formatTable(data, unidade, minIdade=null, maxIdade=null) {
  const lines = data.split("\n");
  let html = '<table>';
  const header = lines[0].split(",");
  const equipeIdx = header.indexOf('EQUIPE');
  ultimaIdadeColIndex = header.indexOf('IDADE');
  if (equipeIdx === -1 || ultimaIdadeColIndex === -1) return '';

  html += '<tr>' + header.map(h => `<th>${h}</th>`).join('') + '</tr>';

  let csv = [];
  let hasData = false;

  // üëâ Identifica automaticamente as colunas de pontua√ß√£o
  const colPontuacao = header.map(h =>
    h.trim().toUpperCase().startsWith("PONTUA√á√ÉO - ")
  );

  for (let i = 1; i < lines.length; i++) {
    const cols = lines[i].split(",");
    if (cols.length <= equipeIdx) continue;

    const equipe = cols[equipeIdx].trim();
    const idade = parseInt(cols[ultimaIdadeColIndex]);

    if (equipe === unidade && (minIdade === null || (idade >= minIdade && idade <= maxIdade))) {
      hasData = true;

      let rowHTML = "<tr>";

      for (let c = 0; c < cols.length; c++) {
        let rawValue = cols[c].trim();
        let display = formatDateBR(rawValue);
        let style = "";

        // üëâ S√≥ aplica cor nas colunas que come√ßam com "PONTUA√á√ÉO - "
        if (colPontuacao[c]) {
          const numero = parseFloat(rawValue.replace(",", "."));

          if (!isNaN(numero)) {
            if (numero === 0) {
              style = "background-color:#e74c3c;color:white;font-weight:bold;text-align:center;";
            } else if (numero > 0) {
              style = "background-color:#3498db;color:white;font-weight:bold;text-align:center;";
            }
          }
        }

        rowHTML += `<td style="${style}">${display}</td>`;
      }

      rowHTML += "</tr>";

      html += rowHTML;
      csv.push(cols.join(","));
    }
  }

  html += "</table>";
  if (!hasData) html = "<p>N√£o existem dados para esse filtro.</p>";

  return { html, csv: lines[0] + "\n" + csv.join("\n") };
}

function loadFile(indicador, unidade) {
  if (indicador === 'Selecione' || unidade === '') {
    document.getElementById('csvContent').innerHTML = '';
    document.getElementById('btnExcel').style.display = 'none';
    document.getElementById('btnPdf').style.display = 'none';
    document.getElementById('faixaEtariaBtns').style.display = 'none';
    return;
  }

  const xhr = new XMLHttpRequest();
  xhr.open('GET', indicador + '.csv', true);

  xhr.onload = function () {
    ultimoCSV = xhr.responseText;
    ultimaUnidade = unidade;

    document.getElementById('faixaEtariaBtns').style.display =
      (indicador === 'c7' ? 'flex' : 'none');

    const formatted = formatTable(ultimoCSV, unidade);
    document.getElementById('csvContent').innerHTML = formatted.html;

    // MOSTRAR IMAGENS
    document.getElementById("btnExcel").style.display = "block";
    document.getElementById("btnPdf").style.display = "block";

    // DOWNLOAD EXCEL
    document.getElementById("btnExcel").onclick = function () {
      const blob = new Blob([formatted.csv], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = window.URL.createObjectURL(blob);
      link.download = 'dados.csv';
      link.click();
    };
  };

  xhr.send();
}

    function filtrarFaixa(btn, min, max) {
      document.querySelectorAll('.age-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const formatted = formatTable(ultimoCSV, ultimaUnidade, min, max);
      document.getElementById('csvContent').innerHTML = formatted.html;
    }

    function removerFiltro() {
      document.querySelectorAll('.age-btn').forEach(b => b.classList.remove('active'));
      const formatted = formatTable(ultimoCSV, ultimaUnidade);
      document.getElementById('csvContent').innerHTML = formatted.html;
    }

    document.getElementById('indicadorSelect').addEventListener('change', function () {
      loadFile(this.value, document.getElementById('unidadeSelect').value);
    });

    document.getElementById('unidadeSelect').addEventListener('change', function () {
      loadFile(document.getElementById('indicadorSelect').value, this.value);
    });

    window.onload = function() { switchModule('APS'); };

    document.getElementById("btnPdf").onclick = function () {
    const { jsPDF } = window.jspdf;

    // nome do indicador selecionado
    const indicadorEl = document.getElementById("indicadorSelect") || document.getElementById("indicador");
    const nomeIndicador = (indicadorEl && indicadorEl.selectedOptions && indicadorEl.selectedOptions[0]) 
    ? indicadorEl.selectedOptions[0].text 
    : "Sem indicador selecionado";

    // usa SEMPRE o √∫ltimo CSV
    const csvText = formatTable(ultimoCSV, ultimaUnidade).csv.trim();
    const lines = csvText.split("\n");

    const header = lines[0].split(",");
    const body = lines.slice(1).map(l => l.split(","));

    const pdf = new jsPDF("landscape", "mm", "a4");

    // largura √∫til da p√°gina
    const pageWidth = pdf.internal.pageSize.getWidth() - 20;
    const colCount = header.length;
    const colWidth = pageWidth / colCount;

    // data/hora para o rodap√©
    const agora = new Date();
    const dataHora = agora.toLocaleString("pt-BR");

    // ===== Fun√ß√£o para gerar o PDF =====
    function gerarPDF(logoBase64 = null) {

        // t√≠tulo (AGORA COM O NOME DO INDICADOR)
        pdf.setFontSize(14);
        pdf.text(`Relat√≥rio de Indicador ‚Äì ${nomeIndicador}`, 14, 14);

        // logo opcional (20x20, mesmo tamanho que voc√™ tinha)
        if (logoBase64) {
            pdf.addImage(
                logoBase64,
                "PNG",
                pdf.internal.pageSize.getWidth() - 30,
                5,
                20,
                20
            );
        }

        pdf.autoTable({
            head: [header],
            body: body,
            startY: 30,
            theme: "grid",

            styles: {
                fontSize: 7,
                cellPadding: 1,
                overflow: "linebreak"
            },

            headStyles: {
                fillColor: [0, 58, 112],
                textColor: 255,
                halign: "center",
                fontStyle: "bold"
            },

            columnStyles: (() => {
                const obj = {};
                for (let i = 0; i < colCount; i++) {
                    obj[i] = { cellWidth: colWidth };
                }
                return obj;
            })(),

            margin: { top: 30, left: 10, right: 10 },

            didDrawPage: function () {
                pdf.setFontSize(7);
                pdf.setTextColor(80);
                pdf.text(
                    `iNFO SUS Mar√≠lia ‚Äî arquivo gerado em ${dataHora}`,
                    10,
                    pdf.internal.pageSize.getHeight() - 5
                );
            }
        });

        pdf.save("dados.pdf");
    }

    // ===== tentativa de carregar logo =====
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.src = "logo.png";

    img.onload = function () {
        const canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        const base64 = canvas.toDataURL("image/png");
        gerarPDF(base64);
    };

    img.onerror = function () {
        gerarPDF(); // sem logo, mas funcional
    };
};
  </script>
</body>
</html>
